\documentclass{eecslides}\usepackage[]{graphicx}\usepackage[]{color}
%% maxwidth is the original width if it is less than linewidth
%% otherwise use linewidth (to make sure the graphics do not exceed the margin)
\makeatletter
\def\maxwidth{ %
  \ifdim\Gin@nat@width>\linewidth
    \linewidth
  \else
    \Gin@nat@width
  \fi
}
\makeatother

\definecolor{fgcolor}{rgb}{0.345, 0.345, 0.345}
\newcommand{\hlnum}[1]{\textcolor[rgb]{0.686,0.059,0.569}{#1}}%
\newcommand{\hlstr}[1]{\textcolor[rgb]{0.192,0.494,0.8}{#1}}%
\newcommand{\hlcom}[1]{\textcolor[rgb]{0.678,0.584,0.686}{\textit{#1}}}%
\newcommand{\hlopt}[1]{\textcolor[rgb]{0,0,0}{#1}}%
\newcommand{\hlstd}[1]{\textcolor[rgb]{0.345,0.345,0.345}{#1}}%
\newcommand{\hlkwa}[1]{\textcolor[rgb]{0.161,0.373,0.58}{\textbf{#1}}}%
\newcommand{\hlkwb}[1]{\textcolor[rgb]{0.69,0.353,0.396}{#1}}%
\newcommand{\hlkwc}[1]{\textcolor[rgb]{0.333,0.667,0.333}{#1}}%
\newcommand{\hlkwd}[1]{\textcolor[rgb]{0.737,0.353,0.396}{\textbf{#1}}}%
\let\hlipl\hlkwb

\usepackage{framed}
\makeatletter
\newenvironment{kframe}{%
 \def\at@end@of@kframe{}%
 \ifinner\ifhmode%
  \def\at@end@of@kframe{\end{minipage}}%
  \begin{minipage}{\columnwidth}%
 \fi\fi%
 \def\FrameCommand##1{\hskip\@totalleftmargin \hskip-\fboxsep
 \colorbox{shadecolor}{##1}\hskip-\fboxsep
     % There is no \\@totalrightmargin, so:
     \hskip-\linewidth \hskip-\@totalleftmargin \hskip\columnwidth}%
 \MakeFramed {\advance\hsize-\width
   \@totalleftmargin\z@ \linewidth\hsize
   \@setminipage}}%
 {\par\unskip\endMakeFramed%
 \at@end@of@kframe}
\makeatother

\definecolor{shadecolor}{rgb}{.97, .97, .97}
\definecolor{messagecolor}{rgb}{0, 0, 0}
\definecolor{warningcolor}{rgb}{1, 0, 1}
\definecolor{errorcolor}{rgb}{1, 0, 0}
\newenvironment{knitrout}{}{} % an empty environment to be redefined in TeX

\usepackage{alltt}
\mode<presentation>
%\usecolortheme{BBSDark}

%%------------------
% Language and font
\usepackage[english]{babel}
\usepackage[utf8]{inputenc}

%%------------------
\usepackage{graphicx}
\usepackage{color}
\usepackage{tikz}
\usetikzlibrary{calc, shapes, backgrounds, arrows}

% --- include packages
\usepackage{subfigure}
\usepackage{multicol}
\usepackage{amsthm}
\usepackage{mathrsfs}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{enumitem}

%%------------------
\DeclareRobustCommand\refmark[1]{\textsuperscript{\ref{#1}}}

%%------------------ Tune the template
\setbeamertemplate{blocks}[rounded][shadow=false]

\title[Day 4]{Hierarchical (multilevel) models}
\vspace{0.4cm}
\vspace{0.6cm}

%%% Begin slideshow
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\begin{document}

\frame{
  \titlepage
}

\section{Introduction}

\frame{
\frametitle{What is a hierarchical model?}

\begin{columns}[T]
\begin{column}{0.6\textwidth}

  {\large\bf Global Model}
  
  \vspace{-0.2cm}

  {\large $$P(y=1) = \beta x + \epsilon$$}
  {\large\bf Seperate model}
  
  \vspace{-0.3cm}
  
  {\large $$\textcolor[rgb]{1,0.65,0}{P(y=1) = \beta_1 x + \epsilon_1}$$}
  
  \vspace{-1cm}
  
  {\large $$\textcolor[rgb]{0,0.75,1}{P(y=1) = \beta_2 x + \epsilon_2}$$}
  
  \vspace{-1cm}
  
  {\large $$\textcolor[rgb]{1,0.08,0.58}{P(y=1) = \beta_3 x + \epsilon_3}$$}
  {\large\bf Hierarchical model}
  
  \vspace{-0.4cm}

  {\large $$P(y=1) = \beta_i x + \epsilon$$}
  
  \vspace{-0.6cm}

  where
  
  \vspace{-0.6cm}

  {\large $$\beta_i \sim {\cal D}(\mu_\beta,\sigma_\beta)$$}
  
  \vspace{-0.1cm}
 
 \begin{itemize}
  \item[$y$] is the distribution of sugar maple
  \item[$x$] is elevation
 \end{itemize}
\end{column}
\begin{column}{0.5\textwidth}
\vspace{-0.5cm}
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}
\includegraphics[width=\maxwidth]{figure/acerSacc2-1} 

\end{knitrout}
\end{column}
\end{columns}
}

\frame{
\frametitle{Why are hierarchical model worth studying?}

\large 

\begin{itemize}
\setlength\itemsep{0.3cm}
  \item To learn about the effect of a treatment that vary
  \item Because it makes it possible to perform inferences using all the data for groups with small sample size
  \item To make prediction of a new unsampled group
  \item Allows to inherently analyse structured data
  \item It is more efficient in making inferences for regression parameters than classical regressions
  \item Makes it possible to include predictors at multiple levels
  \item It accurately acounts for uncertainty in prediction and estimation 
  \item It is a bridge for multivariate modelling
\end{itemize}

}

\section{Model building}

\frame{
\frametitle{Building a hierarchical model}
\framesubtitle{How are the sugar maple and the american beech influenced by elevation?}

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}
\includegraphics[width=\maxwidth]{figure/sp2-1} 

\end{knitrout}

}

\frame{
\frametitle{Building a hierarchical model}
\framesubtitle{Direct Acyclic Graph}

  \begin{center}
    \scalebox{0.5}{
      \includegraphics{Image/DAGbase.pdf}
    }
  \end{center}
}

\frame{
\frametitle{Building a hierarchical model}
\framesubtitle{Direct Acyclic Graph}

  \begin{center}
    \scalebox{0.5}{
      \includegraphics{Image/DAGexample.pdf}
    }
  \end{center}
}

\frame{
\frametitle{Defining the pieces properly}
\framesubtitle{Model}

\Large

\vspace{-0.5cm}

{\Large Model definition}
\begin{align*}
\text{logit}(P(\textcolor{blue}{\mathbf{Y}_{ij}}=1))&=\textcolor{brown}{\beta_j}\textcolor{blue}{\mathbf{X}}\\
P(\textcolor{blue}{\mathbf{Y}_{ij}}=1)&=\frac{e^{\textcolor{brown}{\beta_j}\textcolor{blue}{\mathbf{X}}}}{1+e^{\textcolor{brown}{\beta_j}\textcolor{blue}{\mathbf{X}}}}
\end{align*}
$$\textcolor{brown}{\beta_j}\sim{\cal N}(\textcolor{brown}{\mu},\textcolor{brown}{\sigma^2})$$

{\Large Prior definition}
$$\textcolor{brown}{\mu}\sim{\cal N}(\textcolor{green!50!black}{\mu_0},\textcolor{green!50!black}{\sigma_0^2})$$
$$\frac{1}{\textcolor{brown}{\sigma^2}}\sim{\cal \Gamma}(\textcolor{green!50!black}{\tau_0},\textcolor{green!50!black}{\phi_0})$$
}

\frame{
\frametitle{Defining the pieces properly}
{\Large\bf\textcolor{blue}{Data}}

\vspace{0.2cm}

\begin{description}
  \item[$\mathbf{Y}_{ij}$] The presence (or absence) of species $j$ at location $i$
  \item[$\mathbf{X}$] Elevation
\end{description}

{\Large\bf\textcolor{brown}{Parameters}}

\vspace{0.2cm}

\begin{description}
  \item[$\beta_j$] The importance of elevation for species $j$
  \item[$\mu$] Average response of the species to elevation
  \item[$\sigma^2$] How a species varies in its response to elevation
\end{description}

{\Large\bf \textcolor{green!50!black}{Priors}}

\begin{description}
  \item[$\mu_0$] Mean prior about how $\mu$ is distributed
  \item[$\sigma_0^2$] Variance prior about how $\mu$ is distributed
  \item[$\tau_0$] Scale prior about how $\sigma$ is distributed
  \item[$\phi_0$] rate prior about how $\sigma$ is distributed
\end{description}

\vspace{0.2cm}

}

\section{Parameter estimation}

\frame{
\frametitle{Write your own Gibbs sampler}
\large Write a Gibbs sampler to estimate all parameters of the hierarchical model described previously.

\vspace{0.5cm}


\normalsize
Recall that the general structure of the Gibbs sampler is 

\bf 
Gibbs sampler \texttt{pseudocode} (in its simplest form)

\vspace{0.2cm}

\texttt{for t in 1 to N}

\vspace{0.2cm}

\hspace{0.5cm}\texttt{for i in 1 to nparam}

\vspace{0.2cm}

\hspace{1cm}\texttt{draw theta[i,t] from C[i](theta[-i,t-1], y, X)}

}

\frame{
\frametitle{Write your own Gibbs sampler}
\framesubtitle{A few guidelines}

\Large Recall that
	$$\underbrace{P(\text{Model}|\text{Data})}_{\textcolor{orange}{Posterior}}\propto \underbrace{P(\text{Data}|\text{Model})}_\text{\textcolor{blue}{Likelihood}}\underbrace{P(\text{Model})}_\text{\textcolor{green!50!black}{Prior}}$$

\vspace{0.5cm}
	
	$$P(\boldsymbol{\theta}|\mathbf{Y}) \propto P(\mathbf{Y}|\boldsymbol{\theta})P(\boldsymbol{\theta})$$

}

\frame{
\frametitle{Exercice - Write your own Gibbs sampler}
\framesubtitle{A few guidelines}
\Large Define the different parts... Mathematically

\large

{\large \hspace{0.1cm} Likelihood}
$$P(\textcolor{blue}{\mathbf{Y}_j}|\textcolor{brown}{\beta}, \textcolor{blue}{\mathbf{X}})=\prod^n_{i=1}\left(\frac{e^{\textcolor{brown}{\beta_j}\textcolor{blue}{\mathbf{X}_i}}}{1+e^{\textcolor{brown}{\beta_j}\textcolor{blue}{\mathbf{X}_i}}}\right)^{\textcolor{blue}{\mathbf{Y}_{ij}}} \left(\frac{1}{1+e^{\textcolor{brown}{\beta_j}\textcolor{blue}{\mathbf{X}_i}}}\right)^{1-\textcolor{blue}{\mathbf{Y}_{ij}}}$$

$$P(\textcolor{brown}{\beta_j}|\textcolor{brown}{\mu},\textcolor{brown}{\sigma^2})=\prod^m_{j=1}\dfrac{1}{\textcolor{brown}{\sigma}\sqrt{2\pi}}e^{-\frac{(\textcolor{brown}{\beta_j}-\textcolor{brown}{\mu})^2}{2\textcolor{brown}{\sigma^2}}}$$



%{\large \hspace{0.1cm} log-Likelihood}
%$$\log\left(P(\textcolor{blue}{\mathbf{Y}_j}|\textcolor{brown}{\beta},\textcolor{brown}{\mu},\textcolor{brown}{\sigma}, \textcolor{blue}{\mathbf{X}})\right)=\sum^n_{i=1}\left(\textcolor{blue}{\mathbf{Y}_{ij}}\left(\textcolor{brown}{\beta_j}\textcolor{blue}{\mathbf{X}_i}\right)-\log\left(1+e^{\textcolor{brown}{\beta_j}\textcolor{blue}{\mathbf{X}_i}}\right)\right)$$
%\hspace{0.2cm} where
%$$\textcolor{brown}{\beta_j}\sim{\cal N}(\textcolor{brown}{\mu},\textcolor{brown}{\sigma^2})$$
}

\frame{
\frametitle{Exercice - Write your own Gibbs sampler}
\framesubtitle{A few guidelines}
\Large Define the different parts... Mathematically

\Large

\hspace{0.1cm} Prior
\begin{align*}
  P(\textcolor{brown}{\mu},\textcolor{brown}{\sigma^2})&=(\textcolor{brown}{\mu}|\textcolor{green!50!black}{\mu_0},\textcolor{green!50!black}{\sigma_0})(\textcolor{brown}{\sigma^2}|\textcolor{green!50!black}{\tau_0},\textcolor{green!50!black}{\phi_0})\\
  &=\dfrac{1}{\textcolor{green!50!black}{\sigma_0}\sqrt{2\pi}}e^{-\frac{(\textcolor{brown}{\mu}-\textcolor{green!50!black}{\mu_0})^2}{2\textcolor{green!50!black}{\sigma_0^2}}}\times \frac{\textcolor{green!50!black}{\phi_0}^{\textcolor{green!50!black}{\tau_0}}}{\Gamma(\textcolor{green!50!black}{\tau_0})}\left(\frac{1}{\textcolor{brown}{\sigma^2}}\right)^{\textcolor{green!50!black}{\tau_0}-1}e^{-\textcolor{green!50!black}{\phi_0}\frac{1}{\textcolor{brown}{\sigma^2}}}
\end{align*}
}


\frame{
\frametitle{Exercice - Write your own Gibbs sampler}
\framesubtitle{A few guidelines}

\large

{\Large How to sample each parameter independently}

\vspace{0.3cm}

{\Large\textcolor{brown}{$\beta_j$}}
$$P(\textcolor{brown}{\beta_j}|\textcolor{blue}{\mathbf{Y}_j}, \textcolor{blue}{\mathbf{X}},\textcolor{brown}{\mu},\textcolor{brown}{\sigma^2})\propto
\prod^n_{i=1}\left(\frac{e^{\textcolor{brown}{\beta_j}\textcolor{blue}{\mathbf{X}_i}}}
                        {1+e^{\textcolor{brown}{\beta_j}\textcolor{blue}{\mathbf{X}_i}}}
            \right)^{\textcolor{blue}{\mathbf{Y}_{ij}}}
            \left(\frac{1}{1+e^{\textcolor{brown}{\beta_j}\textcolor{blue}{\mathbf{X}_i}}}
            \right)^{1-\textcolor{blue}{\mathbf{Y}_{ij}}}
            \dfrac{1}{\textcolor{brown}{\sigma}\sqrt{2\pi}}
            e^{-\frac{(\textcolor{brown}{\beta_j}-\textcolor{brown}{\mu})^2}
                     {2\textcolor{brown}{\sigma^2}}}$$
{\Large\textcolor{brown}{$\mu$}}
$$P(\textcolor{brown}{\mu}|\textcolor{blue}{\mathbf{Y}_j}, \textcolor{blue}{\mathbf{X}},\textcolor{brown}{\sigma},\textcolor{brown}{\beta_j})\propto
\prod^n_{i=1}\dfrac{1}{\textcolor{brown}{\sigma}\sqrt{2\pi}}e^{-\frac{(\textcolor{brown}{\beta_j}-\textcolor{brown}{\mu})^2}{2\textcolor{brown}{\sigma^2}}}\times e^{-\frac{(\textcolor{brown}{\mu}-\textcolor{green!50!black}{\mu_0})^2}{2\textcolor{green!50!black}{\sigma_0^2}}}$$
{\Large\textcolor{brown}{$\sigma$}}
$$P(\textcolor{brown}{\sigma}|\textcolor{blue}{\mathbf{Y}_j}, \textcolor{blue}{\mathbf{X}},\textcolor{brown}{\mu},\textcolor{brown}{\beta_j})\propto
\prod^n_{i=1}\dfrac{1}{\textcolor{brown}{\sigma}\sqrt{2\pi}}
      e^{-\frac{(\textcolor{brown}{\beta_j}-\textcolor{brown}{\mu})^2}{2\textcolor{brown}{\sigma^2}}}
      \times 
      \frac{1}{\textcolor{brown}{\sigma^2}}
        ^{\textcolor{green!50!black}{\tau_0}-1}
        e^{-\textcolor{green!50!black}{\phi_0}\frac{1}{\textcolor{brown}{\sigma^2}}}$$
}


\end{document}
